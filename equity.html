<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Equity Market</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f6f7fb;margin:0;padding:24px}
    .wrap{max-width:980px;margin:0 auto;background:#fff;padding:18px;border-radius:10px;box-shadow:0 6px 18px rgba(12,12,12,0.06)}
    header{display:flex;justify-content:space-between;align-items:center}
    h1{margin:0;font-size:20px}
    .muted{color:#666;font-size:13px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}
    .btn{padding:6px 10px;border-radius:6px;border:0;cursor:pointer}
    .btn-primary{background:#0b74de;color:white}
    .btn-danger{background:#e03131;color:white}
    .qty{margin-right:6px;padding:6px 8px;border-radius:6px;border:1px solid #ddd;cursor:pointer}
    .log{margin-top:12px;font-size:13px}
    select{padding:8px;border-radius:6px;border:1px solid #ddd}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Equity Market Access</h1>
        <div id="account" class="muted">Loading user...</div>
      </div>
      <div class="muted">Connected to Apps Script backend</div>
    </header>

    <div style="display:flex;gap:16px;margin-top:16px">
      <div style="flex:1">
        <strong>Watchlist</strong>
        <table id="watch">
          <thead>
            <tr><th>Symbol</th><th>Price</th><th>Actions</th></tr>
          </thead>
          <tbody></tbody>
        </table>

        <div style="margin-top:10px">
          <button id="refresh" class="btn btn-primary">Refresh Prices</button>
        </div>

        <div class="log" id="log"></div>
      </div>

      <div style="width:320px">
        <strong>Quick Trader</strong>
        <p class="muted">Choose a symbol and use quick buttons</p>
        <div style="margin-top:8px">
          <select id="symbolSelect"></select>
        </div>
        <div style="margin-top:10px">
          <button class="qty" id="buy50">Buy 50</button>
          <button class="qty" id="buy100">Buy 100</button>
          <button class="qty" id="buy200">Buy 200</button>
        </div>
        <div style="margin-top:8px">
          <button class="qty" id="sell50">Sell 50</button>
          <button class="qty" id="sell100">Sell 100</button>
          <button class="qty" id="sell200">Sell 200</button>
        </div>
        <div style="margin-top:12px" class="muted small">
          Note: trades are logged as <strong>pending</strong> to your Google Sheet.
        </div>
      </div>
    </div>
  </div>

<script>
/* ====== CONFIG - REPLACE THIS ====== */
const APPS_SCRIPT_EXEC_URL = 'https://script.google.com/macros/s/AKfycbyTwaDgxykIUKmowTNwIqap09RmHpKaPF4lcd1pKeoOd3RzH_ZCM-6IMzqoXQmw1ME/exec'; // e.g. https://script.google.com/macros/s/AKfycb.../exec
const WATCHLIST = ['AAPL','MSFT','GOOGL','TSLA','INFY'];
/* ================================== */

/* --- session / login retrieval --- */
/* tries: 1) URL params (userToken,userName)
         2) window.opener postMessage (handshake)
         3) sessionStorage */
function getQueryParams(){
  const p = new URLSearchParams(window.location.search);
  const obj = {};
  for(const [k,v] of p.entries()) obj[k]=v;
  return obj;
}

function tryOpener(timeout=700){
  return new Promise(resolve=>{
    if(!window.opener) return resolve(null);
    function onMsg(e){
      try{
        const d = typeof e.data === 'string' ? JSON.parse(e.data) : e.data;
        if(d && d.source==='parentSite' && d.userToken){ window.removeEventListener('message',onMsg); resolve(d); }
      }catch(e){}
    }
    window.addEventListener('message', onMsg);
    try{ window.opener.postMessage(JSON.stringify({request:'sendLogin',source:'equityWidget'}),'*'); }catch(e){}
    setTimeout(()=>{ window.removeEventListener('message',onMsg); resolve(null); }, timeout);
  });
}

async function obtainLogin(){
  const q = getQueryParams();
  if(q.userToken){ sessionStorage.setItem('userToken', q.userToken); if(q.userName) sessionStorage.setItem('userName', q.userName); return {userToken:q.userToken,userName:q.userName}; }
  const opener = await tryOpener();
  if(opener && opener.userToken){ sessionStorage.setItem('userToken',opener.userToken); if(opener.userName) sessionStorage.setItem('userName',opener.userName); return {userToken:opener.userToken,userName:opener.userName}; }
  const t = sessionStorage.getItem('userToken');
  if(t) return {userToken:t,userName:sessionStorage.getItem('userName')};
  return null;
}

/* --- UI helpers --- */
const accountEl = document.getElementById('account');
const watchBody = document.querySelector('#watch tbody');
const logEl = document.getElementById('log');
const symbolSelect = document.getElementById('symbolSelect');

function setAccountUI(s){
  if(!s) { accountEl.textContent = 'Not logged in'; return; }
  accountEl.textContent = `User: ${maskName(s.userName || 'user')}`;
}
function maskName(n){ if(!n) return 'user'; return n.length>2 ? n[0]+'••'+n[n.length-1] : '••'; }
function log(msg){ const d = document.createElement('div'); d.textContent = `${new Date().toLocaleTimeString()} — ${msg}`; logEl.prepend(d); }

/* --- Price fetch & render --- */
async function fetchPrices(symbols){
  try{
    const url = new URL(APPS_SCRIPT_EXEC_URL);
    url.searchParams.set('action','getPrices');
    url.searchParams.set('symbols', symbols.join(','));
    const res = await fetch(url.toString());
    if(!res.ok) throw new Error('Network error');
    const j = await res.json();
    return j.prices || {};
  }catch(err){
    console.error(err);
    log('Failed to fetch prices: ' + (err.message||err));
    return {};
  }
}

async function renderWatch(symbols){
  watchBody.innerHTML = '';
  symbolSelect.innerHTML = '';
  const prices = await fetchPrices(symbols);
  symbols.forEach(sym=>{
    const price = prices[sym] !== undefined ? prices[sym] : '—';
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${sym}</td><td id="price-${sym}">${price}</td>
      <td>
        <button class="btn btn-primary" data-sym="${sym}" data-side="buy">Buy</button>
        <button class="btn btn-danger" data-sym="${sym}" data-side="sell">Sell</button>
        <div style="margin-top:8px">
          <button class="qty" data-sym="${sym}" data-side="buy" data-qty="50">50</button>
          <button class="qty" data-sym="${sym}" data-side="buy" data-qty="100">100</button>
          <button class="qty" data-sym="${sym}" data-side="buy" data-qty="200">200</button>
        </div>
      </td>`;
    watchBody.appendChild(tr);

    const opt = document.createElement('option'); opt.value = sym; opt.textContent = sym; symbolSelect.appendChild(opt);
  });
}

/* --- Logging trades to Apps Script --- */
async function logTrade(symbol, side, qty){
  const token = sessionStorage.getItem('userToken');
  if(!token){ alert('No user token found. Trade not logged.'); return; }
  const payload = { action:'logTrade', userToken: token, userName: sessionStorage.getItem('userName')||'', symbol, side, qty };
  try{
    const res = await fetch(APPS_SCRIPT_EXEC_URL + '?action=logTrade', {
      method:'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const j = await res.json();
    if(j && j.success){ log(`Logged ${side.toUpperCase()} ${qty} ${symbol} (row ${j.row})`); }
    else { log('Failed to log trade: '+(j && j.error ? j.error : 'unknown')); }
  }catch(err){
    console.error(err);
    log('Network error while logging trade');
  }
}

/* --- delegated click handling for table buttons --- */
document.addEventListener('click', async (ev)=>{
  const btn = ev.target.closest('button');
  if(!btn) return;
  if(btn.dataset.qty){ // quick qty inside table
    await logTrade(btn.dataset.sym, btn.dataset.side, Number(btn.dataset.qty));
    return;
  }
  if(btn.dataset.sym && btn.dataset.side){ // buy/sell button
    const qty = Number(prompt(`Quantity to ${btn.dataset.side} for ${btn.dataset.sym}`, '100')) || 0;
    if(qty>0) await logTrade(btn.dataset.sym, btn.dataset.side, qty);
    return;
  }
});

/* --- quick trader buttons --- */
['buy50','buy100','buy200','sell50','sell100','sell200'].forEach(id=>{
  const el = document.getElementById(id);
  if(!el) return;
  el.addEventListener('click', async ()=>{
    const sym = symbolSelect.value; if(!sym) return alert('Choose a symbol first');
    const side = id.startsWith('buy') ? 'buy' : 'sell';
    const qty = Number(id.replace(/[^0-9]/g,'')); 
    await logTrade(sym, side, qty);
  });
});

/* --- refresh --- */
document.getElementById('refresh').addEventListener('click', ()=> renderWatch(WATCHLIST));

/* --- init --- */
(async function init(){
  const session = await obtainLogin();
  setAccountUI(session);
  await renderWatch(WATCHLIST);
  log('UI ready');
})();
</script>
</body>
</html>
